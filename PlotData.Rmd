---
title: "StateCoronavirusAnalysis"
author: "Stephen R. Proulx"
date: "3/14/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(lubridate)
library(rstan)
options(mc.cores = parallel::detectCores())
```


```{r loaddata , include=TRUE, cache=TRUE}

confirmed_sheet<-read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv") %>%
  select(-Lat, -Long)
deaths_sheet <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv")%>%
  select(-Lat, -Long)
recovered_sheet <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Recovered.csv")%>%
  select(-Lat, -Long) 



confirmed_long <- gather(confirmed_sheet, -Province.State , -Country.Region , key="date", value = "cases")%>%
  separate(date,c("x","date.longer"),1,remove=TRUE) %>% 
  separate(date.longer,c("month","day","year"),remove=TRUE) %>%
  separate(Province.State,c("location","State"),sep=", ",remove=FALSE) %>% #kludge to get state for US data before 3/10/2020
  mutate(location = as.character(location)) %>%
  mutate(State = as.character(State)) %>%
  mutate(year=as.character(as.numeric(year)+2000)) %>%
  unite(comb.date, c(month,day,year) , sep=".")%>% 
  mutate(date = parse_date(comb.date , "%m%.%d%.%Y"))%>%
  select(-comb.date , -x) %>%
  mutate(delta.days=period_to_seconds(days(ymd(date) - ymd(20200122)))/(60*60*24)) %>% #calculate days since data began being collected
  as_tibble()  
```


Unfortunately the data seems to be grouped into locations that are not consistent throughout the dataset. Before March 10, 2020, the US data is presented by city or county within each state, but after March 10 it is aggregated by state. 

```{r makeWashingtonStateData , include=TRUE, cache=TRUE}

wash.data.substate <- filter(confirmed_long,Country.Region=="US" ,State=="WA") %>%  
  filter(delta.days<48) %>%
  group_by(date,State, delta.days, Country.Region) %>% summarise(mean=mean(cases), count=n() ) %>%
  mutate(total.cases = mean*count) %>% 
  select(-mean, -count)  


wash.data.state <- filter(confirmed_long,Country.Region=="US" , Province.State=="Washington") %>% 
  filter(delta.days>47) %>%
  mutate(State = "WA" , total.cases=cases) %>%
  select(-Province.State,-location,-cases)


WA.data.state <- bind_rows(wash.data.state,wash.data.substate) 


```

```{r PlotWAbyDate, include=TRUE, cache=TRUE}

ggplot(data=filter(WA.data.state, total.cases>5) , aes(x=delta.days,y=log(total.cases)  )) +
  geom_point(aes(color= wday(date , label=TRUE))) +
    geom_smooth(method = "lm")

```



```{r makeCAStateData , include=TRUE, cache=TRUE}

CA.data.substate <- filter(confirmed_long,Country.Region=="US" ,State=="CA", Province.State!="Diamond Princess",Province.State!="Grand Princess") %>%  
  filter(delta.days<48) %>%
  group_by(date,State, delta.days, Country.Region) %>% summarise(mean=mean(cases), count=n() ) %>%
  mutate(total.cases = mean*count) %>% 
  select(-mean, -count)  


CA.data.state <- filter(confirmed_long,Country.Region=="US" , Province.State=="California") %>% 
  filter(delta.days>47) %>%
  mutate(State = "CA" , total.cases=cases) %>%
  select(-Province.State,-location,-cases)


CA.data.state <- bind_rows(CA.data.state,CA.data.substate)  


```

```{r PlotCAbyDate, include=TRUE, cache=TRUE}

ggplot(data=filter(CA.data.state, total.cases>10) , aes(x=delta.days,y=log(total.cases)  )) +
  geom_point(aes(color= wday(date , label=TRUE))) +
    geom_smooth(method = "lm")

```



```{r makeNYStateData , include=TRUE, cache=TRUE}



NY.data.substate <- filter(confirmed_long,Country.Region=="US" ,State=="NY") %>%  
  filter(delta.days<48) %>%
  group_by(date,State, delta.days, Country.Region) %>% summarise(mean=mean(cases), count=n() ) %>%
  mutate(total.cases = mean*count) %>% 
  select(-mean, -count)  

NY.data.state <- filter(confirmed_long,Country.Region=="US" , Province.State=="New York") %>% 
  filter(delta.days>47) %>%
  mutate(State = "NY" , total.cases=cases) %>%
  select(-Province.State,-location,-cases)


NY.data.state <- bind_rows(NY.data.state,NY.data.substate)  


```


```{r makeMAStateData , include=TRUE, cache=TRUE}



MA.data.substate <- filter(confirmed_long,Country.Region=="US" ,State=="MA") %>%  
  filter(delta.days<48) %>%
  group_by(date,State, delta.days, Country.Region) %>% summarise(mean=mean(cases), count=n() ) %>%
  mutate(total.cases = mean*count) %>% 
  select(-mean, -count)  

MA.data.state <- filter(confirmed_long,Country.Region=="US" , Province.State=="Massachusetts") %>% 
  filter(delta.days>47) %>%
  mutate(State = "MA" , total.cases=cases) %>%
  select(-Province.State,-location,-cases)


MA.data.state <- bind_rows(MA.data.state,MA.data.substate)  


```


```{r combineStateTotals}
State.Totals <- bind_rows(MA.data.state,WA.data.state,CA.data.state,NY.data.state) %>% mutate(wday=wday(date,label=TRUE))


ggplot(data=filter(State.Totals,total.cases>20) , aes(x=delta.days,y=log(total.cases, base=10) , group=State)) +
  geom_point(aes(color= wday(date , label=TRUE)))+
    geom_smooth( method = "lm" )+  
  scale_y_continuous( limits=c(1,3),breaks=c(1,2,3), labels=c(10,100,1000))+
  labs( x="days since" , y="cases per state")

ggplot(data=filter(State.Totals,total.cases>20) , aes(x=delta.days,y=log(total.cases, base=10) ,color=State,  group=State)) +
  geom_point()+
    geom_smooth( method = "lm" )+  
  scale_y_continuous( limits=c(1,3),breaks=c(1,2,3), labels=c(10,100,1000))+
  labs( x="days since Jan 22" , y="cases per state")


```
##Run Stan on the data to infer true growth rate and true case counts


```{r writestan , eval=FALSE}


sink("model_PoissonGrowth.stan")
cat("

    data {
    int<lower=0> n; // number of time points
    int days[n];
    int total_cases[n] ;
    }
    transformed data{
    int new_cases[n] ; #really only need n-1 but keep the indexing the same for simplicity
    new_cases[1]=0;
    for(i in 2:n){
    new_cases[i]=total_cases[i]-total_cases[i-1];
    }
    }
    parameters {
    real <lower=0 , upper=50.0> lambda ; // Poisson parameter for the growth rate
    real <lower=0, upper=1> mu ; // Probability that a true case is not detected
    int <lower=0,upper=100 > init_cases ; // Initial number of cases
    }
    transformed parameters{
    int true_cases[n];
    int true_new_cases[n];
    int new_observed_cases[n];
    true_cases[1] = init_cases;
    true_new_cases[1] = 0;
    new_observed_cases[1] = 0

    }
    
    model {
    init_cases ~ poisson(total_cases[1]) ; #Prior for the true number of cases at time point 0 is Poisson with a mean equal to the observed number of cases
    
#should also put in a probability of observing total_cases[1] given true_cases[1]=init_cases

    for(i in 2:n){
    true_new_cases[i] ~ poisson(true_cases[i-1]*lambda); # update for each time step is the sum of Poisson RVs with mean lambda
    true_cases[i]=true_cases[i-1]+true_new_cases[i];
    new_observed_cases[i] ~ binomial(true_cases[i]-total_cases[i] , mu); # some of the unobserved cases may become observed
    total_cases[i] = total_cases[i-1] + new_observed_cases[i];
    }
    }
    
    
    
    
    ",fill = TRUE)
sink()




sink("model_PoissonOnly.stan")
cat("

    data {
    int<lower=0> n; // number of time points
    int days[n];
    int total_cases[n] ;
    }
    transformed data{
    int new_cases[n] ; //really only need n-1 but keep the indexing the same for simplicity
    new_cases[1]=0;
    for(i in 2:n){
    new_cases[i]=total_cases[i]-total_cases[i-1];
    }
    }
    parameters {
    real <lower=0 , upper=50.0> lambda ; // Poisson parameter for the growth rate
    }
    model {
    for(i in 2:n){
    new_cases[i] ~ poisson(total_cases[i-1]*lambda); // update for each time step is the sum of Poisson RVs with mean lambda
    }
    }
    
      
    
    ",fill = TRUE)
sink()

sink("model_PoissonGaussian.stan")
cat("

    data {
    int<lower=0> n; // number of time points
    int days[n];
    int total_cases[n] ;
    }
    transformed data{
    int new_cases[n] ; //really only need n-1 but keep the indexing the same for simplicity
    new_cases[1]=0;
    for(i in 2:n){
    new_cases[i]=total_cases[i]-total_cases[i-1];
    }
    }
    parameters {
    real <lower=0 , upper=2> lambda ; // Poisson parameter for the growth rate
    real <lower=0> sd ; // sd for Gaussian process error

    }
    transformed parameters{
    real dev[n]; // the deviation from the baseline poisson parameter
    }
    model {
    sd ~ cauchy(0.0, 1);
    
    for(i in 1:n){
    dev[i] ~ normal(0,sd);
    }
    
    for(i in 2:n){
    new_cases[i] ~ poisson(total_cases[i-1]*lambda * exp(dev[i]) ); // update for each time step is the sum of Poisson RVs with mean lambda
    }
    }
    
      
    
    ",fill = TRUE)
sink()


sink("model_PoissonGaussian.stan")
cat("
  data {
    int<lower=0> n; // number of time points
    int days[n];
    int total_cases[n] ;
    }
    transformed data{
    int new_cases[n] ; //really only need n-1 but keep the indexing the same for simplicity
    new_cases[1]=0;
    for(i in 2:n){
    new_cases[i]=total_cases[i]-total_cases[i-1];
    }
    }
    parameters {
    real <lower=0 , upper=50.0> lambda ; // Poisson parameter for the growth rate
    }
    transformed parameters{
      real dev[n];
    }
    model {
    for(i in 2:n){
    dev[i]~exponential(1);
    new_cases[i] ~ poisson(total_cases[i-1]*lambda *dev[i] ); // update for each time step is the sum of Poisson RVs with mean lambda
    }
    }
    
      
    
    ",fill = TRUE)
sink()

```


```{r runstan , eval=FALSE}
mydata.sub <- filter(State.Totals,total.cases>20,State == "CA")  

mindays=min(mydata.sub$delta.days)


mydata.sub <- mutate(mydata.sub,days=delta.days-mindays) %>% arrange(days)   %>%
  rename(total_cases=total.cases)

n=max(mydata.sub$days)+1


stan_data <- c(mydata.sub[c("days","total_cases")], list(n=n)) 

#fit the model
fit_poiss <- stan(file = 'model_PoissonOnly.stan', 
                data =stan_data, chains = 4,iter = 1000, seed = 2131231 )

print(fit_poiss, pars=c("lambda"),digits_summary = 3)

```


### run all at once and estimate the day of the week effect


##Old stuff to plot all of the data by date

```{r groupUSdata , include=TRUE, cache = TRUE}


USTotals <- filter(confirmed_long,Country.Region=="US" ) %>%  
  group_by(date, delta.days, Country.Region) %>% summarise(mean=mean(cases), count=n() ) %>%
  mutate(total.cases = mean*count) %>% 
  select(-mean, -count)  %>%
  mutate(Country.Region = "USA") %>%
  rename(cases=total.cases) 

ChinaTotals <- filter(confirmed_long,Country.Region=="China" ) %>%  
  group_by(date, delta.days, Country.Region) %>% summarise(mean=mean(cases), count=n() ) %>%
  mutate(total.cases = mean*count) %>% 
  select(-mean, -count)  %>%
  mutate(Country.Region = "China") %>%
  rename(cases=total.cases) 
 
confirmed_long2 <- bind_rows(filter(confirmed_long,Country.Region!="China",Country.Region!="US"),USTotals,ChinaTotals) 
```

```{r plotbydate  , include=TRUE, cache=TRUE}

#Italy
ggplot(data=filter(confirmed_long,Country.Region=="Italy",cases>20,delta.days>35) , aes(x=delta.days,y=log(cases)  , group=Province.State)) +
  geom_point(aes(color= wday(date , label=TRUE)))+
    geom_smooth(method = "lm")



#France
ggplot(data=filter(confirmed_long,Country.Region=="France",cases>20) , aes(x=delta.days,y=log(cases)  , group=Province.State)) +
  geom_point(aes(color= wday(date , label=TRUE)))+
    geom_smooth(method = "lm")


#France and Italy
ggplot(data=filter(confirmed_long,Country.Region=="Italy" | Country.Region=="France"  | Country.Region=="Spain" | Country.Region=="Germany" | Country.Region=="United Kingdom"   ,cases>20) , aes(x=delta.days,y=log(cases)  , group=Country.Region)) +
  geom_point(aes(color= wday(date , label=TRUE)))+
    geom_smooth(method = "lm")




#Plot a bunch of countries
ggplot(data=filter(confirmed_long2,  Country.Region=="France"  | Country.Region=="Italy"  |  Country.Region=="Spain" | Country.Region=="Germany" | Country.Region=="United Kingdom"| Country.Region=="Brazil" |  Country.Region=="Portugal" | Country.Region=="USA"  | Country.Region=="Switzerland"  | Country.Region=="Norway" | Country.Region=="Netherlands"  | Country.Region=="Denmark"   ,cases>20) , aes(x=delta.days,y=log(cases,base=10) ,color= Country.Region , group=Country.Region)) +
  geom_point(aes(color= Country.Region))+
    geom_smooth(method = "lm") + 
  scale_y_continuous( limits=c(1,6),breaks=c(1,2,3,4,5), labels=c(10,100,1000,10000,100000))+
  scale_x_continuous( limits=c(20,54))+
  labs( x="days since Jan 22" , y="cases per state", title="countries without strong interventions")



#Plot countries with interventions
ggplot(data=filter(confirmed_long2,Country.Region=="China" |Country.Region=="Korea, South" |Country.Region=="Japan" | Country.Region=="Singapore" |Country.Region=="Taiwan*"    ,cases>20) , aes(x=delta.days,y=log(cases,base=10) ,color= Country.Region , group=Country.Region)) +
  geom_point(aes(color= Country.Region))+
    geom_smooth(method = "loess") + 
  scale_y_continuous( limits=c(1,6),breaks=c(1,2,3,4,5), labels=c(10,100,1000,10000,100000))+
   scale_x_continuous( limits=c(20,54))+
  labs( x="days since Jan 22" , y="cases per state" , title="countries with interventions")




#South americans
ggplot(data=filter(confirmed_long2,Country.Region=="Brazil" |Country.Region=="Argentina" |Country.Region=="Chile" | Country.Region=="Mexico" |Country.Region=="Peru"    ,cases>20) , aes(x=delta.days,y=log(cases,base=10) ,color= Country.Region , group=Country.Region)) +
  geom_point(aes(color= Country.Region))+
    geom_smooth(method = "lm") + 
  scale_y_continuous( limits=c(1,6),breaks=c(1,2,3,4,5), labels=c(10,100,1000,10000,100000))+
   scale_x_continuous( limits=c(20,54))+
  labs( x="days since Jan 22" , y="cases per state" , title="countries with interventions")



#Canadians
ggplot(data=filter(confirmed_long2, Country.Region=="Canada"   ,cases>20) , aes(x=delta.days,y=log(cases,base=10) ,color= Province.State , group=Province.State)) +
  geom_point(aes(color= Province.State))+
    geom_smooth(method = "lm") + 
  scale_y_continuous( limits=c(1,6),breaks=c(1,2,3,4,5), labels=c(10,100,1000,10000,100000))+
   scale_x_continuous( limits=c(20,54))+
  labs( x="days since Jan 22" , y="cases per state" , title="countries with interventions")

```



```{r runstanUSA , eval=FALSE}
mydata.sub <- filter(confirmed_long2,cases>20,Country.Region == "USA")  

mindays=min(mydata.sub$delta.days)


mydata.sub <- mutate(mydata.sub,days=delta.days-mindays) %>% arrange(days)   %>%
  rename(total_cases=cases)

n=max(mydata.sub$days)+1


stan_data <- c(mydata.sub[c("days","total_cases")], list(n=n)) 

#fit the model
fit_poiss <- stan(file = 'model_PoissonOnly.stan', 
                data =stan_data, chains = 4,iter = 1000, seed = 2131231 )

print(fit_poiss, pars=c("lambda"),digits_summary = 3)

```

```{r runstanCA , eval=FALSE}
mydata.sub <- filter(State.Totals,total.cases>20,total.cases<101,State == "CA")  

mindays=min(mydata.sub$delta.days)


mydata.sub <- mutate(mydata.sub,days=delta.days-mindays) %>% arrange(days)   %>%
  rename(total_cases=total.cases)

n=max(mydata.sub$days)+1


stan_data <- c(mydata.sub[c("days","total_cases")], list(n=n)) 

#fit the model
fit_poiss <- stan(file = 'model_PoissonOnly.stan', 
                data =stan_data, chains = 4,iter = 1000, seed = 2131231 )

print(fit_poiss, pars=c("lambda"),digits_summary = 3)

```


```{r runstanCA , eval=FALSE}
mydata.sub <- filter(State.Totals,total.cases>100,State == "CA")  

mindays=min(mydata.sub$delta.days)


mydata.sub <- mutate(mydata.sub,days=delta.days-mindays) %>% arrange(days)   %>%
  rename(total_cases=total.cases)

n=max(mydata.sub$days)+1


stan_data <- c(mydata.sub[c("days","total_cases")], list(n=n)) 

#fit the model
fit_poiss <- stan(file = 'model_PoissonOnly.stan', 
                data =stan_data, chains = 4,iter = 1000, seed = 2131231 )

print(fit_poiss, pars=c("lambda"),digits_summary = 3)

```


```{r runstanItaly , eval=FALSE}
mydata.sub <- filter(confirmed_long2,cases>20,cases<50000,Country.Region == "Italy")  

mindays=min(mydata.sub$delta.days)


mydata.sub <- mutate(mydata.sub,days=delta.days-mindays) %>% arrange(days)   %>%
  rename(total_cases=cases)

n=max(mydata.sub$days)+1


stan_data <- c(mydata.sub[c("days","total_cases")], list(n=n)) 

#fit the model
fit_poiss <- stan(file = 'model_PoissonOnly.stan', 
                data =stan_data, chains = 4,iter = 1000, seed = 2131231 )

print(fit_poiss, pars=c("lambda"),digits_summary = 3)

```



```{r runstanFrance , eval=FALSE}
mydata.sub <- filter(confirmed_long2,cases>20,cases<50000,Country.Region == "France")  

mindays=min(mydata.sub$delta.days)


mydata.sub <- mutate(mydata.sub,days=delta.days-mindays) %>% arrange(days)   %>%
  rename(total_cases=cases)

n=max(mydata.sub$days)+1


stan_data <- c(mydata.sub[c("days","total_cases")], list(n=n)) 

#fit the model
fit_poiss <- stan(file = 'model_PoissonOnly.stan', 
                data =stan_data, chains = 4,iter = 1000, seed = 2131231 )

print(fit_poiss, pars=c("lambda"),digits_summary = 3)

```



```{r runstanBrazil , eval=FALSE}
mydata.sub <- filter(confirmed_long2,cases>20,cases<50000,Country.Region == "Brazil")  

mindays=min(mydata.sub$delta.days)


mydata.sub <- mutate(mydata.sub,days=delta.days-mindays) %>% arrange(days)   %>%
  rename(total_cases=cases)

n=max(mydata.sub$days)+1


stan_data <- c(mydata.sub[c("days","total_cases")], list(n=n)) 

#fit the model
fit_poiss <- stan(file = 'model_PoissonOnly.stan', 
                data =stan_data, chains = 4,iter = 1000, seed = 2131231 )

print(fit_poiss, pars=c("lambda"),digits_summary = 3)

```



```{r runstanOntario , eval=FALSE}
mydata.sub <- filter(confirmed_long2,cases>20,Province.State == "Ontario")  

mindays=min(mydata.sub$delta.days)


mydata.sub <- mutate(mydata.sub,days=delta.days-mindays) %>% arrange(days)   %>%
  rename(total_cases=cases)

n=max(mydata.sub$days)+1


stan_data <- c(mydata.sub[c("days","total_cases")], list(n=n)) 

#fit the model
fit_poiss <- stan(file = 'model_PoissonOnly.stan', 
                data =stan_data, chains = 4,iter = 1000, seed = 2131231 )

print(fit_poiss, pars=c("lambda"),digits_summary = 3)

```



```{r runstanBC , eval=FALSE}
mydata.sub <- filter(confirmed_long2,cases>20,Province.State == "British Columbia")  

mindays=min(mydata.sub$delta.days)


mydata.sub <- mutate(mydata.sub,days=delta.days-mindays) %>% arrange(days)   %>%
  rename(total_cases=cases)

n=max(mydata.sub$days)+1


stan_data <- c(mydata.sub[c("days","total_cases")], list(n=n)) 

#fit the model
fit_poiss <- stan(file = 'model_PoissonOnly.stan', 
                data =stan_data, chains = 4,iter = 1000, seed = 2131231 )

print(fit_poiss, pars=c("lambda"),digits_summary = 3)

```